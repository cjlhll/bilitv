# 追番时间表模块复刻指南

## 概述

本指南将详细介绍如何从零开始实现一个类似 PiliPlus 的追番时间表功能。该功能可以展示每日更新的番剧信息，帮助用户跟踪追番进度。

## 实现步骤

### 1. 项目结构设计

首先，创建以下目录结构：

```
lib/
├── models/
│   └── timeline/
│       ├── timeline_model.dart      # 时间表数据模型
│       └── episode_model.dart       # 剧集数据模型
├── services/
│   └── timeline_service.dart        # 时间表API服务
├── pages/
│   └── timeline/
│       ├── timeline_page.dart       # 时间表页面
│       ├── timeline_controller.dart # 时间表控制器
│       └── widgets/
│           ├── timeline_tab.dart     # 日期标签页
│           └── episode_card.dart     # 剧集卡片
└── utils/
    └── date_utils.dart              # 日期工具类
```

### 2. 数据模型设计

#### 2.1 创建剧集模型 (episode_model.dart)

```dart
class Episode {
  final int id;
  final int seasonId;
  final String title;
  final String cover;
  final String episodeIndex;
  final String publishTime;
  final bool isFollowed;
  final int viewCount;
  final int followCount;

  Episode({
    required this.id,
    required this.seasonId,
    required this.title,
    required this.cover,
    required this.episodeIndex,
    required this.publishTime,
    required this.isFollowed,
    required this.viewCount,
    required this.followCount,
  });

  factory Episode.fromJson(Map<String, dynamic> json) {
    return Episode(
      id: json['episode_id'],
      seasonId: json['season_id'],
      title: json['title'] ?? '',
      cover: json['cover'] ?? '',
      episodeIndex: json['pub_index'] ?? '',
      publishTime: json['pub_time'] ?? '',
      isFollowed: json['follow'] == 1,
      viewCount: int.tryParse(json['plays'] ?? '0') ?? 0,
      followCount: int.tryParse(json['follows'] ?? '0') ?? 0,
    );
  }
}
```

#### 2.2 创建时间表模型 (timeline_model.dart)

```dart
class TimelineModel {
  final String date;
  final int timestamp;
  final int dayOfWeek;
  final List<Episode> episodes;
  final bool isToday;

  TimelineModel({
    required this.date,
    required this.timestamp,
    required this.dayOfWeek,
    required this.episodes,
    required this.isToday,
  });

  factory TimelineModel.fromJson(Map<String, dynamic> json) {
    var episodesList = <Episode>[];
    if (json['episodes'] != null) {
      episodesList = (json['episodes'] as List)
          .map((e) => Episode.fromJson(e))
          .toList();
    }

    return TimelineModel(
      date: json['date'] ?? '',
      timestamp: json['date_ts'] ?? 0,
      dayOfWeek: json['day_of_week'] ?? 1,
      episodes: episodesList,
      isToday: json['is_today'] == 1,
    );
  }

  // 合并同一天的不同类型剧集
  void mergeEpisodes(TimelineModel other) {
    if (timestamp == other.timestamp) {
      episodes.addAll(other.episodes);
    }
  }
}
```

### 3. API服务层实现

#### 3.1 创建时间表服务 (timeline_service.dart)

```dart
import 'package:dio/dio.dart';
import '../models/timeline/timeline_model.dart';

class TimelineService {
  final Dio _dio = Dio();
  final String baseUrl = 'https://api.bilibili.com';

  Future<List<TimelineModel>> fetchTimeline({
    int type = 1, // 1: 番剧, 4: 国创
    int beforeDays = 6,
    int afterDays = 6,
  }) async {
    try {
      final response = await _dio.get(
        '$baseUrl/pgc/web/timeline/v2',
        queryParameters: {
          'types': type,
          'before': beforeDays,
          'after': afterDays,
        },
      );

      if (response.statusCode == 200 && response.data['code'] == 0) {
        List<dynamic> results = response.data['result'];
        return results
            .map((json) => TimelineModel.fromJson(json))
            .toList();
      } else {
        throw Exception('Failed to load timeline');
      }
    } catch (e) {
      throw Exception('Error fetching timeline: $e');
    }
  }

  // 获取合并后的时间表（番剧+国创）
  Future<List<TimelineModel>> fetchMergedTimeline() async {
    try {
      // 并发请求番剧和国创数据
      final results = await Future.wait([
        fetchTimeline(type: 1), // 番剧
        fetchTimeline(type: 4), // 国创
      ]);

      final bangumiList = results[0];
      final guochuangList = results[1];

      // 合并数据
      if (bangumiList.isNotEmpty && guochuangList.isNotEmpty) {
        for (int i = 0; i < bangumiList.length; i++) {
          if (i < guochuangList.length) {
            bangumiList[i].mergeEpisodes(guochuangList[i]);
          }
        }
      }

      return bangumiList.isNotEmpty ? bangumiList : guochuangList;
    } catch (e) {
      throw Exception('Error fetching merged timeline: $e');
    }
  }
}
```

### 4. 控制器实现

#### 4.1 创建时间表控制器 (timeline_controller.dart)

```dart
import 'package:get/get.dart';
import '../models/timeline/timeline_model.dart';
import '../services/timeline_service.dart';

class TimelineController extends GetxController {
  final TimelineService _service = TimelineService();
  
  // 状态变量
  final RxList<TimelineModel> timelineList = <TimelineModel>[].obs;
  final RxBool isLoading = false.obs;
  final RxBool hasError = false.obs;
  final RxString errorMessage = ''.obs;
  
  // Tab控制器
  late TabController tabController;
  int initialTabIndex = 0;

  @override
  void onInit() {
    super.onInit();
    loadTimeline();
  }

  // 加载时间表数据
  Future<void> loadTimeline() async {
    try {
      isLoading.value = true;
      hasError.value = false;
      
      final data = await _service.fetchMergedTimeline();
      timelineList.value = data;
      
      // 找到今天的索引
      initialTabIndex = timelineList.indexWhere(
        (item) => item.isToday,
      );
      if (initialTabIndex == -1) initialTabIndex = 0;
      
    } catch (e) {
      hasError.value = true;
      errorMessage.value = e.toString();
    } finally {
      isLoading.value = false;
    }
  }

  // 刷新数据
  Future<void> refreshTimeline() async {
    await loadTimeline();
  }

  @override
  void onClose() {
    tabController.dispose();
    super.onClose();
  }
}
```

### 5. UI界面实现

#### 5.1 创建剧集卡片 (episode_card.dart)

```dart
import 'package:flutter/material.dart';
import '../../models/timeline/episode_model.dart';

class EpisodeCard extends StatelessWidget {
  final Episode episode;
  final VoidCallback? onTap;

  const EpisodeCard({
    Key? key,
    required this.episode,
    this.onTap,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: 120,
        margin: const EdgeInsets.only(right: 12),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 封面图
            Expanded(
              flex: 3,
              child: Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(8),
                  image: DecorationImage(
                    image: NetworkImage(episode.cover),
                    fit: BoxFit.cover,
                  ),
                ),
                child: Stack(
                  children: [
                    // 追番标记
                    if (episode.isFollowed)
                      const Positioned(
                        top: 8,
                        right: 8,
                        child: Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: Colors.pink,
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            '已追番',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 10,
                            ),
                          ),
                        ),
                      ),
                    // 时间标记
                    Positioned(
                      bottom: 8,
                      left: 8,
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 6,
                          vertical: 2,
                        ),
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.6),
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Text(
                          episode.publishTime,
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 10,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 8),
            // 标题和集数
            Expanded(
              flex: 1,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    episode.title,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: const TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    episode.episodeIndex,
                    style: TextStyle(
                      fontSize: 11,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

#### 5.2 创建日期标签页 (timeline_tab.dart)

```dart
import 'package:flutter/material.dart';

class TimelineTab extends StatelessWidget {
  final List<String> dates;
  final List<bool> isTodayList;
  final List<int> dayOfWeekList;

  const TimelineTab({
    Key? key,
    required this.dates,
    required this.isTodayList,
    required this.dayOfWeekList,
  }) : super(key: key);

  String _getDayOfWeek(int day) {
    const days = ['一', '二', '三', '四', '五', '六', '日'];
    return days[day - 1];
  }

  @override
  Widget build(BuildContext context) {
    return TabBar(
      isScrollable: true,
      tabAlignment: TabAlignment.start,
      indicator: BoxDecoration(
        color: Theme.of(context).colorScheme.secondaryContainer,
        borderRadius: BorderRadius.circular(20),
      ),
      labelColor: Theme.of(context).colorScheme.onSecondaryContainer,
      unselectedLabelColor: Theme.of(context).colorScheme.outline,
      tabs: List.generate(dates.length, (index) {
        return Tab(
          text: '${dates[index]} ${isTodayList[index] ? '今天' : '周${_getDayOfWeek(dayOfWeekList[index])}'}',
        );
      }),
    );
  }
}
```

#### 5.3 创建主页面 (timeline_page.dart)

```dart
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'timeline_controller.dart';
import 'widgets/episode_card.dart';
import 'widgets/timeline_tab.dart';

class TimelinePage extends StatelessWidget {
  TimelinePage({Key? key}) : super(key: key);

  final TimelineController controller = Get.put(TimelineController());

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('追番时间表'),
        actions: [
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: controller.refreshTimeline,
          ),
        ],
      ),
      body: Obx(() {
        if (controller.isLoading.value) {
          return const Center(child: CircularProgressIndicator());
        }

        if (controller.hasError.value) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text('加载失败: ${controller.errorMessage.value}'),
                const SizedBox(height: 16),
                ElevatedButton(
                  onPressed: controller.refreshTimeline,
                  child: const Text('重试'),
                ),
              ],
            ),
          );
        }

        if (controller.timelineList.isEmpty) {
          return const Center(
            child: Text('暂无数据'),
          );
        }

        return Column(
          children: [
            // 日期标签页
            TimelineTab(
              dates: controller.timelineList.map((e) => e.date).toList(),
              isTodayList: controller.timelineList.map((e) => e.isToday).toList(),
              dayOfWeekList: controller.timelineList.map((e) => e.dayOfWeek).toList(),
            ),
            // 内容区域
            Expanded(
              child: TabBarView(
                controller: controller.tabController,
                children: controller.timelineList.map((timeline) {
                  return _buildTimelineContent(timeline);
                }).toList(),
              ),
            ),
          ],
        );
      }),
    );
  }

  Widget _buildTimelineContent(TimelineModel timeline) {
    if (timeline.episodes.isEmpty) {
      return const Center(
        child: Text('今天没有更新的番剧'),
      );
    }

    return ListView.builder(
      padding: const EdgeInsets.all(16),
      scrollDirection: Axis.horizontal,
      itemCount: timeline.episodes.length,
      itemBuilder: (context, index) {
        final episode = timeline.episodes[index];
        return EpisodeCard(
          episode: episode,
          onTap: () {
            // 跳转到番剧详情页
            Get.toNamed('/anime/detail', arguments: {
              'seasonId': episode.seasonId,
              'episodeId': episode.id,
            });
          },
        );
      },
    );
  }
}
```

### 6. 路由配置

在路由配置中添加时间表页面：

```dart
GetPage(
  name: '/timeline',
  page: () => TimelinePage(),
  transition: Transition.fadeIn,
),
```

### 7. 日期工具类

创建日期工具类辅助处理日期格式：

```dart
class DateUtils {
  static String formatDate(int timestamp) {
    final date = DateTime.fromMillisecondsSinceEpoch(timestamp * 1000);
    return '${date.month}-${date.day}';
  }

  static int getDayOfWeek(DateTime date) {
    return date.weekday;
  }

  static bool isToday(int timestamp) {
    final now = DateTime.now();
    final date = DateTime.fromMillisecondsSinceEpoch(timestamp * 1000);
    return now.year == date.year && 
           now.month == date.month && 
           now.day == date.day;
  }
}
```

### 8. 状态管理优化

为了更好的状态管理，可以添加以下功能：

1. **本地缓存**: 使用 SharedPreferences 或 Hive 缓存时间表数据
2. **定时刷新**: 实现定时自动刷新功能
3. **离线支持**: 在无网络时显示缓存数据

```dart
// 在控制器中添加缓存逻辑
class TimelineController extends GetxController {
  // ... 现有代码

  // 从缓存加载
  Future<void> loadFromCache() async {
    final cache = await _cacheService.getTimelineCache();
    if (cache != null) {
      timelineList.value = cache;
    }
  }

  // 保存到缓存
  Future<void> saveToCache() async {
    if (timelineList.isNotEmpty) {
      await _cacheService.saveTimelineCache(timelineList);
    }
  }

  // 修改加载方法
  Future<void> loadTimeline() async {
    try {
      // 先显示缓存数据
      await loadFromCache();
      
      // 然后获取最新数据
      isLoading.value = true;
      final data = await _service.fetchMergedTimeline();
      timelineList.value = data;
      
      // 保存到缓存
      await saveToCache();
    } catch (e) {
      // 如果网络请求失败，且没有缓存数据，显示错误
      if (timelineList.isEmpty) {
        hasError.value = true;
        errorMessage.value = e.toString();
      }
    } finally {
      isLoading.value = false;
    }
  }
}
```

### 9. 性能优化建议

1. **图片缓存**: 使用 cached_network_image 优化图片加载
2. **懒加载**: 实现滚动到底部时加载更多数据
3. **预加载**: 预加载前后几天的数据
4. **内存管理**: 及时释放不用的资源

### 10. 测试策略

1. **单元测试**: 测试数据模型解析逻辑
2. **集成测试**: 测试API服务
3. **UI测试**: 测试用户交互流程

## 总结

通过以上步骤，你可以实现一个完整的追番时间表功能。主要特点包括：

1. **模块化设计**: 清晰的代码结构和职责分离
2. **响应式UI**: 使用GetX实现状态管理
3. **性能优化**: 并发请求、缓存机制等
4. **用户体验**: 加载状态、错误处理、离线支持

这个实现方案可以根据具体需求进行调整和扩展，如添加更多功能、优化UI设计等。